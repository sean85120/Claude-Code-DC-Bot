import type { APIEmbed, APIActionRowComponent, APIButtonComponent } from 'discord.js';

// â”€â”€â”€ Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Project definition, corresponding to a whitelisted entry in `projects.json` */
export interface Project {
  name: string;
  path: string;
}

// â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Claude Code permission mode
 * - `default` â€” SDK determines safe operations automatically; others require Discord approval
 * - `acceptEdits` â€” Automatically allow file edits
 * - `bypassPermissions` â€” Bypass all permission checks
 * - `plan` â€” Only allow read-only operations
 */
export type PermissionMode = 'default' | 'acceptEdits' | 'bypassPermissions' | 'plan';

/** Bot global config, derived from environment variables and `projects.json` */
export interface BotConfig {
  discordToken: string;
  discordGuildId: string;
  discordChannelId: string;
  discordClientId: string;
  allowedUserIds: string[];
  defaultCwd: string;
  defaultModel: string;
  defaultPermissionMode: PermissionMode;
  maxMessageLength: number;
  streamUpdateIntervalMs: number;
  rateLimitWindowMs: number;
  rateLimitMaxRequests: number;
  projects: Project[];
  /** Path of the bot's own repo â€” sessions for this path use the general channel */
  botRepoPath: string;
  /** Timeout in ms for tool approval requests â€” auto-deny after this period (default: 5 min) */
  approvalTimeoutMs: number;
  /** Timeout in ms for idle waiting_input sessions â€” auto-archive after this period (default: 30 min) */
  sessionIdleTimeoutMs: number;
}

// â”€â”€â”€ Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Session lifecycle status */
export type SessionStatus =
  | 'idle'
  | 'running'
  | 'awaiting_permission'
  | 'waiting_input'
  | 'completed'
  | 'error';

/** Complete state of a single Claude Code session, keyed by Discord Thread ID */
export interface SessionState {
  sessionId: string | null;
  status: SessionStatus;
  threadId: string;
  userId: string;
  startedAt: Date;
  lastActivityAt: Date;
  promptText: string;
  cwd: string;
  model: string;
  toolCount: number;
  tools: Record<string, number>;
  pendingApproval: PendingApproval | null;
  abortController: AbortController;
  transcript: TranscriptEntry[];
  attachments?: FileAttachment[];
}

/** A single entry in the conversation transcript */
export interface TranscriptEntry {
  timestamp: Date;
  type: 'assistant' | 'tool_use' | 'result' | 'user' | 'error';
  content: string;
  toolName?: string;
}

/** Tracking state for AskUserQuestion multi-question sequential interaction */
export interface AskState {
  totalQuestions: number;
  currentQuestionIndex: number;
  collectedAnswers: Record<string, string>;
  selectedOptions: Set<number>;
  isMultiSelect: boolean;
  questions: Array<{
    question: string;
    header: string;
    options: Array<{ label: string; description: string }>;
    multiSelect: boolean;
  }>;
}

/**
 * Pending tool approval request
 *
 * Core mechanism: After creating a Promise, the `resolve` function is stored in the StateStore.
 * The SDK pauses and waits for the user to click a button in Discord; clicking calls `resolve` to resume.
 */
export interface PendingApproval {
  toolName: string;
  toolInput: unknown;
  messageId: string;
  resolve: (result: PermissionResult) => void;
  createdAt: Date;
  askState?: AskState;
}

/** Permission approval result, generated by Discord button interaction */
export interface PermissionResult {
  behavior: 'allow' | 'deny';
  updatedInput?: unknown;
  message?: string;
}

// â”€â”€â”€ File Attachments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Attachment type: image, document (PDF), or plain text */
export type AttachmentType = 'image' | 'document' | 'text';

/** File attachment uploaded by the user from Discord, converted to base64 */
export interface FileAttachment {
  type: AttachmentType;
  base64: string;
  mediaType: string;
  filename: string;
  textContent?: string;
}

/** @deprecated Use {@link FileAttachment} instead */
export type ImageAttachment = FileAttachment;

// â”€â”€â”€ Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Per-request or cumulative token usage statistics */
export interface TokenUsage {
  input: number;
  output: number;
  cacheRead: number;
  cacheWrite: number;
  total: number;
  costUsd: number;
}

// â”€â”€â”€ Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Formatted display info for tool usage, used to build Discord Embeds */
export interface ToolDisplayInfo {
  title: string;
  description: string;
  fields?: Array<{ name: string; value: string; inline: boolean }>;
}

/** Combined Discord message structure (Embed + Buttons + Text) */
export interface DisplayMessage {
  embeds?: APIEmbed[];
  components?: APIActionRowComponent<APIButtonComponent>[];
  content?: string;
}

// â”€â”€â”€ Colors & Emoji â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Discord Embed color constants */
export const COLORS = {
  PreToolUse: 0x7289da,
  PostToolUse: 0x43b581,
  PostToolUseFailure: 0xf04747,
  Stop: 0x43b581,
  Notification: 0xfaa61a,
  SessionStart: 0x9b59b6,
  SessionEnd: 0x747f8d,
  Running: 0x3498db,
  Permission: 0xe67e22,
  Error: 0xe74c3c,
  Info: 0x95a5a6,
  WaitingInput: 0x2ecc71,
} as const;

/** Emoji icons for each tool */
export const TOOL_EMOJI: Record<string, string> = {
  Read: 'ğŸ“–',
  Write: 'ğŸ“',
  Edit: 'âœï¸',
  Bash: 'ğŸ’»',
  Glob: 'ğŸ”',
  Grep: 'ğŸ”',
  WebFetch: 'ğŸŒ',
  WebSearch: 'ğŸ”',
  Task: 'ğŸ¤–',
  AskUser: 'â“',
  AskUserQuestion: 'â“',
  NotebookEdit: 'ğŸ““',
  EnterPlanMode: 'ğŸ“‹',
  ExitPlanMode: 'ğŸ“‹',
};

// â”€â”€â”€ Permission Mode Display Names â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Display name mapping for permission modes */
export const PERMISSION_MODE_NAMES: Record<string, string> = {
  default: 'Default Mode',
  plan: 'Plan Mode',
  acceptEdits: 'Accept Edits',
  bypassPermissions: 'Bypass Permissions',
};

// â”€â”€â”€ Session Status Display Names â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Display name mapping for session statuses */
export const SESSION_STATUS_NAMES: Record<SessionStatus, string> = {
  idle: 'Idle',
  running: 'Running',
  awaiting_permission: 'Awaiting Approval',
  waiting_input: 'Waiting for Input',
  completed: 'Completed',
  error: 'Error',
};
